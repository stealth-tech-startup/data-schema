version: 4

childPipelines:
    scmUrls:
      - git@github.com:org/repo.git
      - https://git@github.com:org/repo2.git
    startAll: true

shared:
    image: node:4
    environment:
        NODE_TAG: latest

jobs:
    first:
        environment:
            NODE_ENV: production
        matrix:
            NODE_VERSION:
                - 4
                - 5
                - 6
        image: node:{{NODE_VERSION}}
        steps:
            - init: npm install
            - test: npm test
        requires:
            - ~pr
            - ~commit

    publish:
        steps:
            - publish: npm publish
        secrets:
            - NPM_TOKEN
        requires:
            - first

    setup-prod:
        steps:
            - announce: set banner

    teardown-prod:
        steps:
            - publish_blog: publish blog

stages:
    canary:
        jobs:
            - first
        description: "Canary jobs for testing"
    prod:
        setup: setup-prod
        teardown: teardown-prod
        jobs:
            - publish
        description: "Prod deploy jobs"
